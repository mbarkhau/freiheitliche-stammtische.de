<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freiheitliche Stammtische</title>

    <link rel="icon" type="image/png" href="img/logo_64.png">

    <link rel="preload" href="termine.json" as="fetch" type="application/json" crossorigin="anonymous">
    <link rel="stylesheet" href="jsvectormap.css">
    <link rel="stylesheet" href="styles.css">

    <script src="jsvectormap.js"></script>
    <script src="map_de_mill.js"></script>
</head>

<body>
    <header class="site-header">
        <div class="header-container">
            <a href="index.html" class="header-left">
                <img src="img/logo_256.png" alt="Logo" class="site-logo">
                <h1 class="site-title">Freiheitliche<br>Stammtische</h1>
            </a>
            <nav class="header-right">
                <div class="filter-panel">
                    <input class="table-search" placeholder="Suche..." aria-label="Suche">
                    <button id="clear-filter" aria-label="Suche leeren">✕</button>
                </div>
                <button id="theme-toggle" aria-label="Toggle Dark Mode">✹</button>
                <a href="info.html" class="nav-link">Info</a>
            </nav>
        </div>
    </header>

    <main class="main-container">
        <aside id="event-list-container">
            <div id="termine-list" class="list">
                <!-- Cards will be populated by JS -->
            </div>
        </aside>
        <section id="map-view-container">
            <div id="map"></div>
            <div id="selection-overlay" class="map-overlay">
                <!-- Selection details like in mockup -->
            </div>
        </section>
    </main>

    <script>
        // --- Theme Logic ---
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            if (newTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }

            localStorage.setItem('theme', newTheme);
            const button = document.getElementById('theme-toggle');
            button.textContent = newTheme === 'dark' ? '✹' : '☾';

            if (globalMapMarkers && globalTermine) {
                initMap(globalMapMarkers, globalTermine);
            }
        }

        function initTheme() {
            let savedTheme = localStorage.getItem('theme');
            if (!savedTheme) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    savedTheme = 'dark';
                }
            }

            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }

            const button = document.getElementById('theme-toggle');
            if (button) {
                button.textContent = savedTheme === 'dark' ? '✹' : '☾';
            }
        }

        function getMapColors() {
            const style = getComputedStyle(document.documentElement);
            return {
                fill: style.getPropertyValue('--map-fill').trim() || '#fcfcfc',
                stroke: style.getPropertyValue('--map-stroke').trim() || '#d1d1d1',
                accent: style.getPropertyValue('--accent-color').trim() || '#c5a059'
            };
        }

        // --- Date & Formatting Utilities ---
        function getRelativeDateString(dateStr) {
            if (!dateStr) return '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const eventDate = new Date(dateStr + 'T00:00:00');
            const diffTime = eventDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'heute';
            if (diffDays === 1) return 'morgen';
            if (diffDays === -1) return 'gestern';

            const weeks = Math.abs(Math.round(diffDays / 7));
            const months = Math.abs(Math.round(diffDays / 30));
            if (diffDays > 0) {
                if (months > 2) return `in ${months} Monaten`;
                if (weeks > 2) return `in ${weeks} Wochen`;
                return `in ${diffDays} Tagen`;
            } else {
                if (months > 2) return `vor ${months} Monaten`;
                if (weeks > 2) return `vor ${weeks} Wochen`;
                return `vor ${Math.abs(diffDays)} Tagen`;
            }
        }

        const MONTH_NAMES = ["JAN", "FEB", "MÄR", "APR", "MAI", "JUN", "JUL", "AUG", "SEP", "OKT", "NOV", "DEZ"];

        function getDetailedDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return {
                dayNum: date.getDate(),
                month: MONTH_NAMES[date.getMonth()],
                yearSuffix: String(date.getFullYear()).slice(2)
            };
        }

        function cityText(termin) {
            const dist = termin.city_dist;
            return dist < 15 ? termin.city : ('bei ' + termin.city);
        }

        function formatKontakt(kontakt, email) {
            if (!kontakt && !email) return '';
            if (email) {
                const recipient = kontakt ? `${kontakt.trim()} <${email.trim()}>` : email.trim();
                return `<a href="mailto:${encodeURIComponent(recipient)}">${kontakt || email}</a>`;
            }
            return kontakt || '';
        }

        // --- Card List Management ---
        function populateList(termine) {
            const listContainer = document.querySelector('#termine-list');
            listContainer.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];

            termine.forEach(t => {
                const dateInfo = getDetailedDate(t.date);
                const card = document.createElement('div');
                card.className = 'event-card';
                card.id = 'marker-' + t.originalIndex;
                card.dataset.date = t.date; // Store date for filtering

                if (t.date < today) {
                    card.classList.add('past-event');
                    card.style.opacity = '0.6';
                }

                // Hidden search content for better search accuracy
                const searchContent = [
                    t.name, t.city, t.plz, t.state, t.orga, t.kontakt, t['e-mail'], t.date, t.dow
                ].filter(v => v).join(' ').toLowerCase();

                card.innerHTML = `
                    <div class="search-content" style="display: none;">${searchContent}</div>
                    <div class="date-badge">
                        <span class="day-name">${t.dow || ''}</span>
                        <div class="day-month">
                            <span class="day-num">${dateInfo.dayNum}</span>
                            <span class="month">${dateInfo.month}</span>
                        </div>
                        <span class="relative-date">${getRelativeDateString(t.date)}</span>
                    </div>
                    <div class="event-info">
                        <h3 class="event-title">${t.name || ''}</h3>
                        <div class="event-detail">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            <span>${t.plz || ''} ${cityText(t)}</span>
                        </div>
                        <div class="event-detail">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            <span>${t.orga || ''}</span>
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => {
                    updateSelectionPanel(t, true);
                    // On mobile, maybe don't scroll map into view automatically if user is browsing cards?
                    // But we want to show the marker on the map too.
                    if (currentMap) {
                        currentMap.setFocus({
                            coords: t.coords,
                            scale: 3,
                            animate: true
                        });
                    }
                });

                listContainer.appendChild(card);
            });
        }

        // --- Map Logic ---
        let currentMap = null;
        let globalTermine = null;
        let globalMapMarkers = null;

        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function initMap(mapMarkers, events) {
            if (currentMap) {
                currentMap.destroy();
            }
            document.getElementById('map').innerHTML = '';

            const colors = getMapColors();

            try {
                currentMap = new jsVectorMap({
                    markersSelectable: true,
                    markersSelectableOne: true,
                    selector: '#map',
                    map: 'de_mill',
                    backgroundColor: 'transparent',
                    draggable: true,
                    bindTouchEvents: true,
                    regionStyle: {
                        initial: {
                            fill: colors.fill,
                            stroke: colors.stroke,
                            strokeWidth: 0.8
                        },
                    },
                    zoomButtons: false,
                    zoomOnScroll: true,
                    markers: [...mapMarkers],
                    onMarkerClick: function (event, index) {
                        const marker = globalMapMarkers[index];
                        const today = new Date().toISOString().split('T')[0];

                        // Find all events for this marker
                        const markerTermine = globalTermine.filter(t => marker.ids.includes(t.originalIndex));

                        // Find the first future event, or fallback to the first event
                        const termin = markerTermine.find(t => t.date >= today) || markerTermine[0];

                        updateSelectionPanel(termin, true);
                    },
                    onRegionClick: function (event, code) {
                        updateSearch(code);
                        if (window.innerWidth <= 900) {
                            document.getElementById('event-list-container').scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                });
            } catch (e) {
                console.error("Map Error:", e);
                document.getElementById('map').innerHTML = '<p style="padding: 20px;">Fehler beim Laden der Karte.</p>';
            }
        }

        function updateSelectionPanel(termin, showOverlay = true) {
            const overlay = document.getElementById('selection-overlay');
            if (showOverlay) {
                overlay.style.display = 'block';
                const relativeDate = getRelativeDateString(termin.date);
                overlay.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0; font-size: 1.1rem;">${termin.name || ''}</h4>
                        <button onclick="document.getElementById('selection-overlay').style.display='none'" class="map-overlay-close">✕</button>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 0.25rem;">
                        <div>${termin.date || ''} (${termin.dow || ''}) — ${relativeDate}</div>
                        <div><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> <a href="https://maps.google.com/?q=${termin.plz},${cityText(termin)},Deutschland" target="_blank">${termin.plz || ''} ${cityText(termin)}</a></div>
                        <div><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg> ${formatKontakt(termin.kontakt, termin['e-mail'])}</div>
                        <div style="margin-top: 0.5rem;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> ${termin.orga_www ? `<a href="${termin.orga_www}" target="_blank">${termin.orga || 'Link'}</a>` : (termin.orga || '')}</div>
                        ${termin.link_qr ? `<div style="margin-top: 0.5rem;">${termin.link ? `<a href="${termin.link}" target="_blank">` : ''}<img src="${termin.link_qr}" alt="QR Code" style="width: 100%; max-width: 150px; border-radius: 4px;">${termin.link ? '</a>' : ''}</div>` : ''}
                    </div>
                `;
            } else {
                overlay.style.display = 'none';
            }
        }

        function updateSearch(val) {
            const today = new Date().toISOString().split('T')[0];
            const searchInput = document.querySelector('.filter-panel .table-search');
            if (searchInput) searchInput.value = val;

            if (val.trim() === '') {
                document.querySelectorAll('.event-card').forEach(card => {
                    if (card.dataset.date < today) {
                        card.style.display = 'none';
                    } else {
                        card.style.display = 'flex';
                    }
                });
            } else {
                // Show all matches (including past) and check search string
                const lowerVal = val.toLowerCase();
                document.querySelectorAll('.event-card').forEach(card => {
                    const searchContent = card.querySelector('.search-content').textContent;
                    if (searchContent.includes(lowerVal)) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
        }

        async function loadData() {
            initTheme();
            const response = await fetch('termine.json');
            let termine = await response.json();
            const today = new Date().toISOString().split('T')[0];

            // Map original index to all events for reliable lookup
            termine = termine.map((t, i) => ({ ...t, originalIndex: i }));

            // Sort by date ASC
            termine.sort((a, b) => (a.date || '').localeCompare(b.date || ''));

            // Group markers
            const groups = {};
            termine.forEach(t => {
                const coordKey = t.coords.join(',');
                if (!groups[coordKey]) groups[coordKey] = [];
                groups[coordKey].push(t);
            });

            const markerRadius = window.innerWidth <= 720 ? 10 : 7;
            const colors = getMapColors();

            const mapMarkers = Object.values(groups).map((group, markerIndex) => {
                const hasFutureEvent = group.some(t => t.date >= today);
                const markerColor = hasFutureEvent ? colors.accent : "#888";
                const coords = group[0].coords;
                const ids = group.map(t => t.originalIndex);

                return {
                    name: group[0].city,
                    coords: coords,
                    style: { initial: { fill: markerColor, r: markerRadius, stroke: "#333", strokeWidth: 1 } },
                    ids: ids
                };
            });

            globalTermine = termine;
            globalMapMarkers = mapMarkers;

            populateList(termine);
            initMap(mapMarkers, termine);

            // Initialization: Hide past events by default
            updateSearch('');

            // Search logic
            const searchInput = document.querySelector('.filter-panel .table-search');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(function (e) {
                    updateSearch(e.target.value);
                }, 150));
            }

            const clearButton = document.getElementById('clear-filter');
            if (clearButton) {
                clearButton.addEventListener('click', () => updateSearch(''));
            }

            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) themeBtn.addEventListener('click', toggleTheme);

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('selection-overlay').style.display = 'none';
                }
            });

            document.addEventListener('pointerup', (e) => {
                const overlay = document.getElementById('selection-overlay');
                if (overlay.style.display === 'block') {
                    const isOverlay = e.target.closest('#selection-overlay');
                    const isMarker = e.target.closest('.jvm-marker') || e.target.classList.contains('jvm-marker');
                    const isCard = e.target.closest('.event-card');

                    if (!isOverlay && !isMarker && !isCard) {
                        overlay.style.display = 'none';
                    }
                }

                // Clear search if clicking map backdrop
                const mapContainer = document.getElementById('map');
                if (mapContainer && mapContainer.contains(e.target)) {
                    const isElement = e.target.closest('.jvm-element');
                    const isZoomBtn = e.target.closest('.jvm-zoom-btn');
                    if (!isElement && !isZoomBtn) {
                        updateSearch('');
                    }
                }
            });

        }

        window.addEventListener('DOMContentLoaded', loadData);
        window.addEventListener('resize', debounce(() => {
            if (globalMapMarkers) initMap(globalMapMarkers, globalTermine);
        }, 150));
    </script>
</body>

</html>